{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "adminUsername": {
        "type": "string"
      },
      "authenticationType": {
        "type": "string"
      },
      "adminPasswordOrKey": {
        "type": "string"
      },
      "discover-username" :{
        "type": "string"
      },
      "discover-password" :{
        "type": "string"
      },
      "orch-password": {
        "type": "string"
      },
     "replication-password": {
        "type": "string"
      },
      "namespace": {
        "type": "string"
      },
      "vmbasename": {
        "type": "string"
      },
      "vmSize": {
        "type": "string"
      },
     "virtualNetworkName": {
        "type": "string"
      },
      "subnetName": {
        "type": "string"
      },
      "zone": {
        "type": "string",
        "defaultValue": "1",
        "allowedValues": [
            "1",
            "2",
            "3"
        ],
        "metadata": {
            "description": "Zone number for the virtual machine"
        }
      },
      "location": {
        "type": "string",
        "metadata": {
          "description": "Location for all resources."
        }
      },
      "_artifactsLocation": {
      "type": "string",
      "defaultValue": "[deployment().properties.templatelink.uri]",
      "metadata": {
        "description": "The base URI where artifacts required by this template are located. When the template is deployed using the accompanying scripts, a private location in the subscription will be used and this value will be automatically generated."
      }
    },
    "_artifactsLocationSasToken": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated."
      }
    },
    "MySQLRole": {
        "type": "string",
        "defaultValue": "source",
        "allowedValues": [
            "source",
            "replica"
        ],
        "metadata": {
          "description": "Role of the MySQL Instance"
        }
      },
    "UniqueInstanceId": {
        "type": "string",
        "metadata": {
          "description": "ID of the MySQL instance"
        }
      },
    "OpenArkPrivateIp": {
        "type": "string",
        "metadata": {
          "description": "Private IP of the OpenArk VM"
        }
      },
      "SourcePrivateIp": {
        "type": "string",
        "metadata": {
          "description": "Private IP of the Primary/Source VM"
        }
      }
    },
    "variables": {
        //"sharedTemplateUrl": "[uri(parameters('_artifactsLocation'), concat('nested/shared-resources.json', parameters('_artifactsLocationSasToken')))]",
        "OpenArkTemplateUrl": "[uri('https://raw.githubusercontent.com/shashwatchandra/mysql/main/', 'openark-resources.json')]",
        "OpenArkParaTemplateUrl": "[uri('https://raw.githubusercontent.com/shashwatchandra/mysql/main/', 'open-ark-resources.paramters.json')]",
        "SourceTemplateUrl": "[uri('https://raw.githubusercontent.com/shashwatchandra/mysql/main/', 'primary-resources.json')]",
        "SourceParaTemplateUrl": "[uri('https://raw.githubusercontent.com/shashwatchandra/mysql/main/', 'primary-resources.paramters.json')]",
        "ReplicaTemplateUrl": "[uri('https://raw.githubusercontent.com/shashwatchandra/mysql/main/', 'replica-resources.json')]",
        "ReplicaParaTemplateUrl": "[uri('https://raw.githubusercontent.com/shashwatchandra/mysql/main/', 'replica01-resources.paramters.json')]"
    },
    "resources": [
        // {
        // "apiVersion": "2020-11-01",
        // "type": "Microsoft.Network/virtualNetworks",
        // "name": "[parameters('networkSettings').virtualNetworkName]",
        // "location": "[parameters('location')]",
        // "properties": {
        //     "addressSpace": {
        //     "addressPrefixes": [
        //         "[parameters('networkSettings').addressPrefix]"
        //     ]
        //     },
        //     "subnets": [
        //     {
        //         "name": "[parameters('networkSettings').subnet.dse.name]",
        //         "properties": {
        //         "addressPrefix": "[parameters('networkSettings').subnet.dse.prefix]"
        //         }
        //     }
        //     ]
        //   }
        // },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-10-01",
            "name": "OpenArkNode",
            "dependsOn": [
                //"[resourceId('Microsoft.Resources/deployments/', 'shared')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('OpenArkTemplateUrl')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                        "adminUsername":{
                            "value": "[parameters('adminUsername')]"  
                        },
                         "authenticationType": {
                            "value": "[parameters('authenticationType')]"
                        },
                         "adminPasswordOrKey": {
                          "value": "[parameters('adminPasswordOrKey')]"
                        },
                         "discover-username" :{
                            "value": "[parameters('discover-username')]"
                        },
                        "discover-password" :{
                            "value": "[parameters('discover-password')]"
                        },
                        "orch-password": {
                        "value": "[parameters('orch-password')]"
                        },
                        "_artifactsLocation": {
                            "value": "[parameters('_artifactsLocation')]"
                        },
                        "_artifactsLocationSasToken": {
                            "value": "[parameters('_artifactsLocationSasToken')]"
                        },
                        "location": {
                            "value": "[parameters('location')]"
                        },
                        "namespace": {
                            "value": "[parameters('namespace')]"
                        },
                        "vmbasename": {
                            "value": "[parameters('vmbasename')]"
                        },
                        "vmSize": {
                            "value": "[parameters('vmSize')]"
                        },
                        "virtualNetworkName": {
                            "value": "[parameters('virtualNetworkName')]"
                        },
                        "subnetName": {
                            "value": "[parameters('subnetName')]"
                        },
                        "zone": {
                            "value": "[parameters('zone')]"
                        }
                }
              
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-10-01",
            "name": "SourceNode",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments/', 'OpenArkNode')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('SourceTemplateUrl')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                        "adminUsername":{
                            "value": "[parameters('adminUsername')]"  
                        },
                         "authenticationType": {
                            "value": "[parameters('authenticationType')]"
                        },
                         "adminPasswordOrKey": {
                        "value": "[parameters('adminPasswordOrKey')]"
                        },
                         "replication-password": {
                            "value": "[parameters('replication-password')]"
                        },
                        "orch-password": {
                        "value": "[parameters('orch-password')]"
                        },
                        "_artifactsLocation": {
                            "value": "[parameters('_artifactsLocation')]"
                        },
                        "_artifactsLocationSasToken": {
                            "value": "[parameters('_artifactsLocationSasToken')]"
                        },
                        "location": {
                            "value": "[parameters('location')]"
                        },
                        "namespace": {
                            "value": "[parameters('namespace')]"
                        },
                        "vmbasename": {
                            "value": "[parameters('vmbasename')]"
                        },
                        "vmSize": {
                            "value": "[parameters('vmSize')]"
                        },
                        "virtualNetworkName": {
                            "value": "[parameters('virtualNetworkName')]"
                        },
                        "subnetName": {
                            "value": "[parameters('subnetName')]"
                        },
                        "zone": {
                            "value": "[parameters('zone')]"
                        },
                        "MySQLRole": {
                            "value": "[parameters('MySQLRole')]"
                        },
                        "UniqueInstanceId": {
                            "value": "[parameters('UniqueInstanceId')]"
                        },
                        "OpenArkPrivateIp": {
                           "value": "[reference('OpenArkNode').outputs.openarkNic.value]"
                        }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-10-01",
            "name": "ReplicaNode",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments/', 'OpenArkNode')]",
                "[resourceId('Microsoft.Resources/deployments/', 'SourceNode')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('ReplicaTemplateUrl')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                        "OpenArkPrivateIp": {
                            "value": "[reference('OpenArkNode').outputs.openarkNic.value]"
                        },
                        "SourcePrivateIp": {
                            "value": "[reference('SourceNode').outputs.replicaPublicIP.value]"
                        },
                        "zone": {
                            "value": "2"
                        },
                        "MySQLRole": {
                            "value": "replica"
                        },
                        "UniqueInstanceId": {
                            "value": "2"
                        },
                        "adminUsername":{
                            "value": "[parameters('adminUsername')]"  
                        },
                         "authenticationType": {
                            "value": "[parameters('authenticationType')]"
                        },
                         "adminPasswordOrKey": {
                        "value": "[parameters('adminPasswordOrKey')]"
                        },
                         "replication-password": {
                            "value": "[parameters('replication-password')]"
                        },
                        "orch-password": {
                        "value": "[parameters('orch-password')]"
                        },
                        "_artifactsLocation": {
                            "value": "[parameters('_artifactsLocation')]"
                        },
                        "_artifactsLocationSasToken": {
                            "value": "[parameters('_artifactsLocationSasToken')]"
                        },
                        "location": {
                            "value": "[parameters('location')]"
                        },
                        "namespace": {
                            "value": "[parameters('namespace')]"
                        },
                        "vmbasename": {
                            "value": "[parameters('vmbasename')]"
                        },
                        "vmSize": {
                            "value": "[parameters('vmSize')]"
                        },
                        "virtualNetworkName": {
                            "value": "[parameters('virtualNetworkName')]"
                        },
                        "subnetName": {
                            "value": "[parameters('subnetName')]"
                        }
                }
            }
        }
    ]
}